<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Test - Demo Mode</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #1565c0;
        }
        .demo-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #856404;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .widget-container {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            min-height: 600px;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #1976d2;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CustomGPT Widget Test - Demo Mode</h1>
        
        <div class="info">
            <strong>‚ÑπÔ∏è Testing Widget Integration</strong><br>
            This page tests the widget integration with the new changes including demo mode support.
        </div>

        <div class="demo-info">
            <strong>üé≠ Demo Mode Active</strong><br>
            The widget is running in demo mode with the following limitations:
            <ul style="margin: 5px 0;">
                <li>3 agents/projects maximum</li>
                <li>5 conversations maximum</li>
                <li>20 messages per conversation</li>
                <li>30-minute session duration</li>
                <li>Read-only operations (no editing/deleting)</li>
            </ul>
        </div>

        <!-- Test 1: Embedded Widget -->
        <div class="section">
            <h2>Test 1: Embedded Widget</h2>
            <p>Widget embedded directly in the page container.</p>
            <div id="embedded-widget" class="widget-container"></div>
            <div class="status" id="embedded-status">Status: Not initialized</div>
        </div>

        <!-- Test 2: Floating Widget -->
        <div class="section">
            <h2>Test 2: Floating Widget</h2>
            <p>Floating widget in the bottom-right corner.</p>
            <button onclick="toggleFloating()">Toggle Floating Widget</button>
            <button onclick="openFloating()">Open</button>
            <button onclick="closeFloating()">Close</button>
            <div class="status" id="floating-status">Status: Not initialized</div>
        </div>

        <!-- Test 3: Demo Mode Features -->
        <div class="section">
            <h2>Test 3: Demo Mode Features</h2>
            <p>Test demo mode specific features and restrictions.</p>
            <button onclick="testConversationLimit()">Test Conversation Limit</button>
            <button onclick="testMessageLimit()">Test Message Limit</button>
            <button onclick="checkUsageStats()">Check Usage Stats</button>
            <div class="status" id="demo-status">Demo mode features ready</div>
        </div>
    </div>

    <!-- Load the widget script -->
    <script src="./dist/widget/customgpt-widget.js"></script>
    
    <script>
        let embeddedWidget = null;
        let floatingWidget = null;
        
        // Initialize widgets when page loads
        window.addEventListener('DOMContentLoaded', () => {
            initializeWidgets();
        });
        
        function initializeWidgets() {
            // Check if CustomGPTWidget is available
            if (typeof CustomGPTWidget === 'undefined') {
                updateStatus('embedded-status', 'Error: Widget script not loaded');
                updateStatus('floating-status', 'Error: Widget script not loaded');
                return;
            }
            
            // Initialize embedded widget
            try {
                embeddedWidget = CustomGPTWidget.init({
                    agentId: 1, // Demo agent ID
                    agentName: 'Demo Assistant',
                    mode: 'embedded',
                    containerId: 'embedded-widget',
                    theme: 'light',
                    enableConversationManagement: true,
                    maxConversations: 5, // Demo mode limit
                    onOpen: () => {
                        console.log('Embedded widget opened');
                        updateStatus('embedded-status', 'Widget opened');
                    },
                    onClose: () => {
                        console.log('Embedded widget closed');
                        updateStatus('embedded-status', 'Widget closed');
                    },
                    onMessage: (msg) => {
                        console.log('Message:', msg);
                        updateStatus('embedded-status', `Message sent/received`);
                    },
                    onConversationChange: (conv) => {
                        console.log('Conversation changed:', conv);
                        updateStatus('embedded-status', `Switched to: ${conv.title}`);
                    }
                });
                updateStatus('embedded-status', 'Widget initialized successfully');
            } catch (error) {
                console.error('Failed to initialize embedded widget:', error);
                updateStatus('embedded-status', `Error: ${error.message}`);
            }
            
            // Initialize floating widget
            try {
                floatingWidget = CustomGPTWidget.init({
                    agentId: 2, // Different demo agent ID
                    agentName: 'Floating Demo Assistant',
                    mode: 'floating',
                    position: 'bottom-right',
                    theme: 'light',
                    enableConversationManagement: true,
                    maxConversations: 5,
                    isolateConversations: true, // Isolate from embedded widget
                    onOpen: () => {
                        console.log('Floating widget opened');
                        updateStatus('floating-status', 'Widget opened');
                    },
                    onClose: () => {
                        console.log('Floating widget closed');
                        updateStatus('floating-status', 'Widget closed');
                    }
                });
                updateStatus('floating-status', 'Widget initialized successfully');
            } catch (error) {
                console.error('Failed to initialize floating widget:', error);
                updateStatus('floating-status', `Error: ${error.message}`);
            }
        }
        
        // Helper functions
        function updateStatus(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = `Status: ${message} (${new Date().toLocaleTimeString()})`;
            }
        }
        
        // Floating widget controls
        function toggleFloating() {
            if (floatingWidget) {
                floatingWidget.toggle();
                updateStatus('floating-status', 'Widget toggled');
            }
        }
        
        function openFloating() {
            if (floatingWidget) {
                floatingWidget.open();
            }
        }
        
        function closeFloating() {
            if (floatingWidget) {
                floatingWidget.close();
            }
        }
        
        // Demo mode feature tests
        function testConversationLimit() {
            if (!embeddedWidget) {
                updateStatus('demo-status', 'Widget not initialized');
                return;
            }
            
            const conversations = embeddedWidget.getConversations();
            updateStatus('demo-status', `Current conversations: ${conversations.length}/5`);
            
            if (conversations.length < 5) {
                const newConv = embeddedWidget.createConversation(`Test Conversation ${conversations.length + 1}`);
                if (newConv) {
                    updateStatus('demo-status', `Created conversation: ${newConv.title}`);
                } else {
                    updateStatus('demo-status', 'Failed to create conversation (limit reached?)');
                }
            } else {
                updateStatus('demo-status', 'Conversation limit reached (5 max in demo mode)');
            }
        }
        
        function testMessageLimit() {
            updateStatus('demo-status', 'Message limit is 20 per conversation in demo mode');
        }
        
        async function checkUsageStats() {
            updateStatus('demo-status', 'Checking usage stats...');
            
            // Trigger usage update event
            window.dispatchEvent(new Event('demoUsageUpdate'));
            
            // Check localStorage for demo stats
            const stats = localStorage.getItem('customgpt_demo_stats');
            if (stats) {
                const parsed = JSON.parse(stats);
                updateStatus('demo-status', `Stats: ${JSON.stringify(parsed, null, 2)}`);
            } else {
                updateStatus('demo-status', 'No demo stats found in localStorage');
            }
        }
        
        // Enable debug mode for more information
        window.CUSTOMGPT_DEBUG = true;
    </script>
</body>
</html>